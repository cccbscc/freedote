<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freedote Pro - Cloud Workbench</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* =========================================
           ğŸ¨ Design System (è®¾è®¡ç³»ç»Ÿ)
           ========================================= */
        :root {
            --primary: #2563eb;       
            --primary-hover: #1d4ed8;
            --bg-body: #f8fafc;       
            --bg-panel: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #334155;     
            --text-light: #64748b;
            --border: #e2e8f0;        
            --radius-lg: 12px;
            --radius-md: 8px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; }

        body { 
            margin: 0; padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-body); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; /* ç¦æ­¢æ•´é¡µæ»šåŠ¨ï¼Œä½¿ç”¨å†…éƒ¨æ»šåŠ¨ */
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* =========================================
           ğŸ” Login Overlay (ç™»å½•é®ç½©)
           ========================================= */
        #loginOverlay {
            position: fixed; inset: 0; 
            background: rgba(248, 250, 252, 0.95); 
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-card {
            background: white; width: 380px; padding: 40px;
            border-radius: 16px; 
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            border: 1px solid var(--border);
            text-align: center;
        }
        .login-title { font-size: 1.5rem; font-weight: 800; color: #1e293b; margin-bottom: 5px; }
        .login-subtitle { font-size: 0.9rem; color: #64748b; margin-bottom: 25px; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 0.8rem; font-weight: 600; color: #475569; margin-bottom: 5px; }
        .form-input { 
            width: 100%; padding: 10px 12px; 
            border: 1px solid #cbd5e1; border-radius: 6px;
            font-size: 0.95rem; outline: none; transition: border 0.2s;
        }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }
        
        .auth-btns { display: flex; gap: 10px; margin-top: 20px; }
        
        /* =========================================
           ğŸ–¥ï¸ Main Layout (å·¦å³åˆ†å±)
           ========================================= */
        .split-view {
            display: flex; width: 100%; height: 100%;
            opacity: 0; transition: opacity 0.3s ease-in; /* ç™»å½•åæ¸æ˜¾ */
        }

        /* å·¦ä¾§ï¼šå·¥ä½œå° (Workbench) */
        .panel-left {
            flex: 1; /* 50% å®½åº¦ */
            display: flex; flex-direction: column;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            padding: 20px;
            min-width: 350px;
        }

        /* å³ä¾§ï¼šæ¡£æ¡ˆæŸœ (Archive) */
        .panel-right {
            flex: 1; /* 50% å®½åº¦ */
            display: flex; flex-direction: column;
            background: white;
            padding: 20px;
            min-width: 350px;
            overflow-y: hidden; /* å†…éƒ¨æ»šåŠ¨ */
        }

        /* é€šç”¨å¤´éƒ¨æ  */
        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px;
            border-bottom: 1px dashed var(--border);
        }
        .panel-title { font-weight: 700; color: #475569; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        .panel-actions { font-size: 0.85rem; color: var(--text-light); cursor: pointer; }
        .panel-actions:hover { color: var(--primary); }

        /* =========================================
           ğŸ“ Components: Input & Drafts
           ========================================= */
        /* è¾“å…¥å¡ç‰‡ */
        .input-wrapper {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        textarea.main-input {
            width: 100%; height: 100px;
            border: none; outline: none; resize: none;
            font-size: 1rem; line-height: 1.6;
            color: var(--text-main);
            font-family: 'Consolas', 'Monaco', monospace; /* æ–¹ä¾¿çœ‹å¯¹é½ */
        }

        /* æŒ‰é’®ç»„ */
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn {
            flex: 1; padding: 8px 0;
            border: none; border-radius: 6px;
            font-size: 0.9rem; font-weight: 600; cursor: pointer;
            transition: background 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-secondary { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-accent { background: #dbeafe; color: var(--primary); border: 1px solid #bfdbfe; }
        .btn-accent:hover { background: #bfdbfe; }
        .btn-primary { background: var(--primary); color: white; width: 100%; padding: 12px; margin-top: 10px; box-shadow: var(--shadow-md); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; transform: none; }

        /* è‰ç¨¿æµå®¹å™¨ */
        .draft-container {
            flex: 1; overflow-y: auto;
            margin-bottom: 10px;
            padding-right: 5px;
        }
        /* å•ä¸ªè‰ç¨¿æ°”æ³¡ */
        .draft-bubble {
            background: white;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
            transition: transform 0.1s;
        }
        .draft-bubble:hover { border-color: #94a3b8; }
        .draft-info { 
            display: flex; justify-content: space-between; 
            font-size: 0.75rem; color: #94a3b8; margin-bottom: 6px; 
            border-bottom: 1px dashed #f1f5f9; padding-bottom: 4px;
        }
        .draft-text { 
            font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap; word-break: break-all;
            max-height: 200px; overflow-y: hidden; /* é•¿æ–‡æŠ˜å  */
            position: relative;
        }
        /* å±•å¼€å…¨æ–‡çš„é®ç½©å’ŒæŒ‰é’® */
        .draft-expand-btn {
            display: none; font-size: 0.75rem; color: var(--primary); 
            cursor: pointer; margin-top: 4px; text-align: center; background: #f8fafc;
        }

        .draft-controls {
            display: flex; justify-content: flex-end; gap: 12px; margin-top: 8px;
        }
        .icon-btn { cursor: pointer; font-size: 0.85rem; color: #cbd5e1; transition: color 0.2s; }
        .icon-btn:hover { color: var(--primary); }
        .icon-btn.del:hover { color: #ef4444; }

        /* =========================================
           ğŸ“š Components: Knowledge Base
           ========================================= */
        /* æœç´¢æ¡† */
        .search-box {
            width: 100%; padding: 10px 12px;
            border: 1px solid var(--border); border-radius: 8px;
            margin-bottom: 15px; outline: none;
            background: #f8fafc;
        }
        .search-box:focus { background: white; border-color: var(--primary); }

        /* å†…å®¹åŒºåŸŸ */
        .kb-scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; }

        /* Topic å¡ç‰‡ */
        .topic-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            overflow: hidden; /* é˜²æ­¢åœ†è§’æº¢å‡º */
        }
        .topic-header {
            padding: 15px 20px;
            background: #fff;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; user-select: none;
            border-bottom: 1px solid transparent;
            transition: background 0.2s;
        }
        .topic-header:hover { background: #f8fafc; }
        .topic-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin: 0; }
        .topic-toggle { color: #cbd5e1; font-size: 0.8rem; transition: transform 0.3s; }
        
        /* æŠ˜å çŠ¶æ€ */
        .topic-card.collapsed .topic-header { border-bottom: none; }
        .topic-card.collapsed .topic-body { display: none; }
        .topic-card.collapsed .topic-toggle { transform: rotate(-90deg); }

        .topic-body { padding: 20px; background: #fff; border-top: 1px solid #f1f5f9; }
        
        /* æ€»ç»“å— */
        .summary-box {
            background: #fffbeb; color: #92400e; 
            padding: 10px 15px; border-radius: 6px;
            font-size: 0.9rem; margin-bottom: 15px;
            border-left: 3px solid #f59e0b;
        }
        
        /* åˆ—è¡¨é¡¹ */
        .section-title { font-size: 0.95rem; font-weight: 700; color: #475569; margin: 15px 0 8px 0; }
        .kb-list { padding-left: 20px; margin: 0; }
        .kb-list li { margin-bottom: 6px; line-height: 1.6; color: #334155; }
        
        /* æœç´¢é«˜äº® */
        .highlight { background: #fef08a; padding: 0 2px; border-radius: 2px; }

        /* =========================================
           âš™ï¸ Settings & Footer
           ========================================= */
        .status-bar {
            margin-top: 10px; font-size: 0.8rem; color: #94a3b8;
            display: flex; align-items: center; justify-content: space-between;
        }
        .sync-indicator { display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; }
        .dot.online { background: #22c55e; box-shadow: 0 0 4px #22c55e; }
        .dot.syncing { background: #f59e0b; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }

        /* è®¾ç½® API çš„å¼¹çª— */
        #apiModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 320px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
    <div class="login-card">
        <h2 style="margin-top:0; color:#334155;">Freedote Pro</h2>
        <p style="color:#64748b; font-size:0.9rem; margin-bottom:20px;">äº‘ç«¯çŸ¥è¯†åº“ Â· æ™ºèƒ½åŒæ­¥</p>
        
        <input type="email" id="email" class="form-input" placeholder="é‚®ç®± (name@example.com)">
        
        <input type="password" id="password" class="form-input" placeholder="å¯†ç  (è‡³å°‘6ä½)">

        <button id="loginBtn" class="btn-primary" onclick="handleSmartAuth()">
            ğŸš€ ç™»å½• / è‡ªåŠ¨æ³¨å†Œ
        </button>
        
        <div id="loginMsg" style="color:#ef4444; font-size:0.85rem; margin-top:10px; min-height:20px;"></div>
        
        <div style="border-top:1px solid #eee; padding-top:15px; margin-top:15px;">
            <button onclick="startOfflineMode()" style="background:none; border:none; color:#94a3b8; text-decoration:underline; cursor:pointer; font-size:0.9rem;">
                æš‚ä¸ç™»å½•ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼ â”
            </button>
        </div>
    </div>
</div>

    <div id="apiModal">
        <div class="modal-content">
            <h3 style="margin-top:0">âš™ï¸ è®¾ç½® DeepSeek API</h3>
            <p style="font-size:0.85rem; color:#666; margin-bottom:10px;">ç”¨äºé©±åŠ¨â€œAI ä¸€é”®æ•´ç†â€åŠŸèƒ½ã€‚</p>
            <input type="password" id="apiKeyInput" class="form-input" placeholder="sk-..." style="margin-bottom:15px;">
            <button class="btn btn-primary" onclick="saveApiKey()">ä¿å­˜é…ç½®</button>
            <button class="btn btn-secondary" onclick="document.getElementById('apiModal').style.display='none'" style="margin-top:10px">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="split-view" id="mainApp">
        
        <div class="panel-left">
            <div class="panel-header">
                <div class="panel-title">ğŸ§ª å®éªŒå° / è‰ç¨¿ç®±</div>
                <div class="panel-actions" onclick="openApiSettings()">âš™ï¸ é…ç½®</div>
            </div>

            <div class="input-wrapper">
                <textarea id="mainInput" class="main-input" placeholder="åœ¨æ­¤é€Ÿè®°... æ”¯æŒ CO2+ç©ºæ ¼ è‡ªåŠ¨ä¸‹æ ‡"></textarea>
                <div class="btn-row">
                    <button class="btn btn-secondary" onclick="saveToDraft()">
                        <span>â¬‡ï¸</span> æ‰”è¿›è‰ç¨¿ç®±
                    </button>
                    <button class="btn btn-accent" onclick="directSave()">
                        <span>ğŸ“</span> é€Ÿè®°ä¸Šå±
                    </button>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.8rem; color:#94a3b8;">
                <span>ç¼“å†²æ±  (<span id="draftCount">0</span>)</span>
                <span style="cursor:pointer; color:#ef4444;" onclick="clearAllDrafts()">æ¸…ç©º</span>
            </div>
            
            <div id="draftStream" class="draft-container">
                </div>

            <button id="organizeBtn" class="btn btn-primary" onclick="organizeAll()">
                ğŸ§  AI ä¸€é”®æ•´ç†å½’æ¡£
            </button>

            <div class="status-bar">
                <div class="sync-indicator">
                    <div id="syncDot" class="dot"></div>
                    <span id="userStatus">æœªè¿æ¥</span>
                </div>
                <div style="cursor:pointer; text-decoration:underline;" onclick="handleLogout()">é€€å‡º</div>
            </div>
        </div>

        <div class="panel-right">
            <div class="panel-header">
                <div class="panel-title">ğŸ“š ç»“æ„åŒ–çŸ¥è¯†åº“</div>
                <div class="panel-actions" onclick="expandAll()">å±•å¼€å…¨éƒ¨</div>
            </div>

            <input type="text" class="search-box" placeholder="ğŸ” å…¨å±€æœç´¢ (å…³é”®è¯é«˜äº®)..." oninput="handleSearch(this.value)">

            <div id="kbContent" class="kb-scroll-area">
                <div style="text-align:center; color:#cbd5e1; margin-top:100px;">
                    <div>ğŸ“­</div>
                    <div style="margin-top:10px;">æš‚æ— å½’æ¡£å†…å®¹</div>
                </div>
            </div>
        </div>
    </div>

<script>
    // === 0. é¢„è®¾è¯´æ˜ä¹¦ (æ–°ç”¨æˆ·é»˜è®¤æ˜¾ç¤º) ===
    const DEFAULT_NOTE_DATA = {
      "tabs": [
        { "id": "tab_guide", "name": "ğŸ“˜ ä½¿ç”¨æ‰‹å†Œ" },
        { "id": "tab_demo", "name": "ğŸ§ª å®éªŒè®°å½•(ç¤ºä¾‹)" }
      ],
      "content_map": {
        "tab_guide": {
          "å¿«é€Ÿå…¥é—¨": {
            "summary": "æ¬¢è¿ä½¿ç”¨ Freedoteï¼è¿™æ˜¯ä¸€ä¸ªæ‡‚ä½ çš„ AI çŸ¥è¯†åº“ã€‚",
            "sections": [
              { "title": "å¦‚ä½•è®°å½•ï¼Ÿ", "items": ["ç›´æ¥åœ¨å·¦ä¾§è¾“å…¥å†…å®¹ã€‚", "è¾“å…¥ @åˆ†ç±» å¯ä»¥è‡ªåŠ¨å½’æ¡£ã€‚"] }
            ]
          }
        }
      },
      "settings": {}
    };

    // ============================================
    // âš ï¸ Supabase é…ç½® (å·²å¡«å¥½ä½ çš„ Key)
    // ============================================
    const SUPABASE_URL = 'https://bqziigrbjnabrtmpixnn.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxemlpZ3Jiam5hYnJ0bXBpeG5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0OTU2NzcsImV4cCI6MjA4MTA3MTY3N30.h45zVtr58IhT5-CYbTWBUZ2Cs9W9vzbK31qnTftlPmw'; 
    // ============================================

    // === 1. åˆå§‹åŒ–æ ¸å¿ƒå˜é‡ (ä¿®å¤å†²çªçš„å…³é”®ç‚¹) ===
    let sbClient = null; // ğŸ‘ˆ å˜é‡åæ”¹äº†ï¼Œä¸å†å’Œ window.supabase å†²çª
    let isLocalMode = false;
    let currentUser = null;
    let noteData = { tabs: [], content_map: {}, settings: {} }; 
    let currentTabId = 'tab_guide';
    let isEditMode = false;

    // === 2. é¡µé¢åŠ è½½ä¸åˆå§‹åŒ– ===
    window.onload = async function() {
        // æ‰‹æœºç«¯æ ·å¼è°ƒæ•´
        if(window.innerWidth < 768) document.getElementById('inputPanel').classList.add('collapsed');

        // æ¢å¤ API Key
        if(localStorage.getItem('apiKey')) document.getElementById('apiKey').value = localStorage.getItem('apiKey');

        // åˆå§‹åŒ– Supabase
        try {
            if(window.supabase && SUPABASE_URL.startsWith('http')) {
                sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch(e) { console.error("Supabase åˆå§‹åŒ–é”™è¯¯:", e); }

        // æ£€æŸ¥è‡ªåŠ¨ç™»å½•
        if(sbClient) {
            const { data: { session } } = await sbClient.auth.getSession();
            if (session) {
                switchLoginMode('cloud');
                loginSuccess(session.user, true);
                return;
            }
        }

        // æ£€æŸ¥ç¦»çº¿æ¨¡å¼
        if(localStorage.getItem('is_local_mode') === 'true') {
            switchLoginMode('local');
            enterLocalMode();
        }
    }

    // === 3. æ¨¡å¼åˆ‡æ¢ UI ===
    function switchLoginMode(mode) {
        document.getElementById('tabLocal').className = mode==='local' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('tabCloud').className = mode==='cloud' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('localForm').style.display = mode==='local' ? 'block' : 'none';
        document.getElementById('cloudForm').style.display = mode==='cloud' ? 'block' : 'none';
    }

    function enterLocalMode() {
        isLocalMode = true;
        currentUser = { id: 'local_user', email: 'Local@User' };
        localStorage.setItem('is_local_mode', 'true');
        
        // æ›´æ–° UI
        document.getElementById('userEmail').innerText = "ğŸ  æœ¬åœ°æ¨¡å¼";
        document.getElementById('modeTag').innerText = "ç¦»çº¿ç‰ˆ";
        if(document.getElementById('syncOption')) document.getElementById('syncOption').style.display = 'none';
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('appContainer').classList.remove('blur');
        
        loadData(); // è°ƒç”¨åé¢çš„å‡½æ•°
    }

    // === 4. æ™ºèƒ½ç™»å½•/æ³¨å†Œé€»è¾‘ (ä¿®å¤ç‰ˆ) ===
    async function handleLogin() {
        if(!sbClient) return alert("Supabase æœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®");
        
        const btn = document.getElementById('loginBtn'); // æ³¨æ„ï¼šå¦‚æœä¸å«è¿™ä¸ªidï¼Œè¯·æ”¹HTML
        const msg = document.getElementById('loginMsg') || document.createElement('div');
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();

        if(!email || !password) {
            msg.innerText = "è¯·è¾“å…¥è´¦å·å’Œå¯†ç ";
            return;
        }

        try {
            if(btn) btn.disabled = true; 
            msg.innerText = "è¿æ¥ä¸­...";

            // 1. å°è¯•ç™»å½•
            let { data, error } = await sbClient.auth.signInWithPassword({ email, password });

            if (error) {
                // 2. ç™»å½•å¤±è´¥ -> å°è¯•æ³¨å†Œ
                console.log("ç™»å½•å¤±è´¥ï¼Œå°è¯•æ³¨å†Œ:", error.message);
                msg.innerText = "è´¦å·ä¸å­˜åœ¨ï¼Œæ­£åœ¨è‡ªåŠ¨æ³¨å†Œ...";
                
                const regRes = await sbClient.auth.signUp({ email, password });
                
                if (regRes.error) {
                    msg.innerText = "æ³¨å†Œå¤±è´¥: " + regRes.error.message;
                } else {
                    // 3. æ³¨å†ŒæˆåŠŸ -> è‡ªåŠ¨ç™»å½•
                    const loginRetry = await sbClient.auth.signInWithPassword({ email, password });
                    if (!loginRetry.error) {
                        loginSuccess(loginRetry.data.user, true);
                    } else {
                        msg.innerText = "æ³¨å†ŒæˆåŠŸä½†ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•";
                    }
                }
            } else {
                // ç™»å½•æˆåŠŸ
                loginSuccess(data.user, true);
            }
        } catch(e) { 
            msg.innerText = "é”™è¯¯: " + e.message; 
            console.error(e);
        } finally { 
            if(btn) btn.disabled = false; 
        }
    }

    // ç™»å½•æˆåŠŸåçš„å¤„ç†
    async function loginSuccess(user, isCloud) {
        isLocalMode = false;
        currentUser = user;
        localStorage.removeItem('is_local_mode');
        
        document.getElementById('userEmail').innerText = `â˜ï¸ ${user.email}`;
        document.getElementById('modeTag').innerText = "äº‘ç«¯ç‰ˆ";
        if(document.getElementById('syncOption')) document.getElementById('syncOption').style.display = 'block';
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('appContainer').classList.remove('blur');
        
        await loadData();
    }

    async function handleLogout() {
        if(!confirm("ç¡®å®šé€€å‡ºï¼Ÿ")) return;
        localStorage.removeItem('is_local_mode');
        if(!isLocalMode && sbClient) await sbClient.auth.signOut();
        location.reload();
    }

    // ==========================================
    // 2ï¸âƒ£ æ•°æ®ä¿å­˜ä¸åŒæ­¥ (SYNC)
    // ==========================================
    function saveData() {
        // 1. æœ¬åœ°å¿…å­˜ (é˜²ä¸¢)
        localStorage.setItem('freedote_local_data', JSON.stringify(appData));
        
        // 2. äº‘ç«¯åŒæ­¥ (é˜²æŠ–: 2ç§’åæ‰§è¡Œ)
        if (!isOffline && currentUser && supabase) {
            updateSyncStatus('syncing');
            clearTimeout(saveTimer);
            
            saveTimer = setTimeout(async () => {
                // Upsert (å­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥)
                const { error } = await supabase
                    .from('notes')
                    .upsert({ user_id: currentUser.id, content: appData }, { onConflict: 'user_id' });

                if (error) {
                    console.error("åŒæ­¥å¤±è´¥", error);
                    alert("âš ï¸ äº‘ç«¯åŒæ­¥å¤±è´¥ï¼Œæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°");
                } else {
                    updateSyncStatus('online');
                }
            }, 2000);
        }
    }

    function updateSyncStatus(status) {
        const dot = document.getElementById('syncDot');
        dot.className = `dot ${status}`;
        const label = document.getElementById('userStatus');
        if (status === 'syncing') label.innerText = 'åŒæ­¥ä¸­...';
        if (status === 'online') label.innerText = currentUser ? currentUser.email : 'åœ¨çº¿';
    }

    // ==========================================
    // 3ï¸âƒ£ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (CORE LOGIC)
    // ==========================================
    
    // --- æ¸²æŸ“æ€»å…¥å£ ---
    function renderAll() {
        renderDrafts();
        renderKB();
        document.getElementById('draftCount').innerText = appData.drafts.length;
    }

    // --- è‰ç¨¿ç®±é€»è¾‘ ---
    function saveToDraft() {
        const input = document.getElementById('mainInput');
        const text = input.value.trim();
        if (!text) return;

        // åŠ åˆ°å‰é¢
        appData.drafts.unshift({
            id: Date.now(),
            text: text,
            time: new Date().toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'})
        });
        
        saveData();
        input.value = '';
        input.focus(); // ä¿æŒç„¦ç‚¹ä»¥ä¾¿è¿ç»­è¾“å…¥
        renderDrafts();
    }

    function renderDrafts() {
        const container = document.getElementById('draftStream');
        const countSpan = document.getElementById('draftCount');
        countSpan.innerText = appData.drafts.length;

        if (appData.drafts.length === 0) {
            container.innerHTML = `<div style="text-align:center; color:#cbd5e1; padding:20px; font-size:0.9rem;">
                ğŸ‘‹ å˜¿ï¼Œè¿™é‡Œæ˜¯ç©ºçš„ã€‚<br>åœ¨ä¸Šé¢å†™ç‚¹ä»€ä¹ˆï¼Œç„¶åç‚¹å‡»â€œâ¬‡ï¸â€å­˜ä¸‹æ¥ã€‚
            </div>`;
            return;
        }

        let html = '';
        appData.drafts.forEach((d, i) => {
            // åˆ¤æ–­é•¿æ–‡ (è¶…è¿‡100å­—ç¬¦)
            const isLong = d.text.length > 100;
            const contentDisplay = isLong ? d.text : d.text; // CSSæ§åˆ¶æŠ˜å 
            
            html += `
                <div class="draft-bubble">
                    <div class="draft-info">
                        <span>ğŸ•’ ${d.time}</span>
                        <span>#${appData.drafts.length - i}</span>
                    </div>
                    
                    <div class="draft-text ${isLong ? 'collapsed' : ''}" id="draft-${d.id}" 
                         style="${isLong ? 'max-height:80px;mask-image:linear-gradient(180deg,#000 60%,transparent);' : ''}">
                         ${escapeHtml(d.text)}
                    </div>
                    
                    ${isLong ? `<div class="draft-expand-btn" style="display:block" onclick="toggleExpand('${d.id}', this)">å±•å¼€å…¨æ–‡ â–¼</div>` : ''}

                    <div class="draft-controls">
                        <span class="icon-btn" title="ç›´æ¥ä¸Šå±" onclick="promoteDraft(${i})">ğŸ“ é€Ÿè®°</span>
                        <span class="icon-btn" title="å¤åˆ¶" onclick="copyText('${escapeHtml(d.text)}')">ğŸ“‹</span>
                        <span class="icon-btn del" title="åˆ é™¤" onclick="deleteDraft(${i})">ğŸ—‘ï¸</span>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function toggleExpand(id, btn) {
        const el = document.getElementById(`draft-${id}`);
        if (el.style.maxHeight) {
            el.style.maxHeight = '';
            el.style.maskImage = '';
            btn.innerText = 'æ”¶èµ· â–²';
        } else {
            el.style.maxHeight = '80px';
            el.style.maskImage = 'linear-gradient(180deg,#000 60%,transparent)';
            btn.innerText = 'å±•å¼€å…¨æ–‡ â–¼';
        }
    }

    function deleteDraft(index) {
        if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡è‰ç¨¿å—ï¼Ÿ")) {
            appData.drafts.splice(index, 1);
            saveData();
            renderDrafts();
        }
    }
    
    function clearAllDrafts() {
        if(appData.drafts.length === 0) return;
        if(confirm("âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰è‰ç¨¿å—ï¼Ÿ")) {
            appData.drafts = [];
            saveData();
            renderDrafts();
        }
    }

    // æŠŠè‰ç¨¿è½¬æ­£ (Promote)
    function promoteDraft(index) {
        const d = appData.drafts[index];
        // å¡«å…¥è¾“å…¥æ¡†å¹¶è°ƒç”¨é€Ÿè®°
        document.getElementById('mainInput').value = d.text;
        directSave();
        // åˆ æ‰åŸè‰ç¨¿
        appData.drafts.splice(index, 1);
        saveData();
        renderDrafts();
    }

    // --- é€Ÿè®°é€»è¾‘ ---
    function directSave() {
        const input = document.getElementById('mainInput');
        const text = input.value.trim();
        if(!text) return;

        const dateKey = new Date().toLocaleDateString();
        const topic = `ğŸ“… æ—¥å¸¸è®°å½• (${dateKey})`;
        
        // ç¡®ä¿ç»“æ„å­˜åœ¨
        if (!appData.kb[topic]) {
            appData.kb[topic] = { summary: "æœªç» AI æ•´ç†çš„é€Ÿè®°æµæ°´è´¦", sections: [] };
        }
        let section = appData.kb[topic].sections.find(s => s.title === "é€Ÿè®°");
        if (!section) {
            section = { title: "é€Ÿè®°", items: [] };
            appData.kb[topic].sections.push(section);
        }
        
        // æ’å…¥
        section.items.push(text);
        
        saveData();
        input.value = '';
        renderKB();
        
        // æ»šåŠ¨åˆ°è¯¥ Topic
        setTimeout(() => {
            const el = document.getElementById(`topic-${topic}`);
            if(el) {
                el.scrollIntoView({behavior:'smooth'});
                el.classList.remove('collapsed');
            }
        }, 100);
    }

    // --- AI æ•´ç†é€»è¾‘ ---
    async function organizeAll() {
        if (appData.drafts.length === 0) return alert("è‰ç¨¿ç®±æ˜¯ç©ºçš„ï¼Œä¸ç”¨æ•´ç†ã€‚");
        
        const apiKey = localStorage.getItem('deepseek_key');
        if (!apiKey) {
            openApiSettings();
            return alert("è¯·å…ˆè®¾ç½® API Key");
        }

        const btn = document.getElementById('organizeBtn');
        const oldText = btn.innerText;
        btn.innerText = "â³ æ­£åœ¨è¯»å–è‰ç¨¿å¹¶åˆ†æ...";
        btn.disabled = true;

        // æ„é€  Prompt
        const draftContent = appData.drafts.map(d => `[${d.time}] ${d.text}`).join("\n");
        const kbContext = JSON.stringify(appData.kb); // å…¨é‡å‘é€å¯èƒ½å¤ªå¤§ï¼Œå®é™…å»ºè®®åªå‘ keys æˆ– summaryï¼Œè¿™é‡Œå…ˆå‘å…¨é‡
        
        const prompt = `
            ã€è§’è‰²ã€‘ä½ æ˜¯ä¸€ä¸ªä¸¥è°¨çš„ç”Ÿç‰©å·¥ç¨‹ç§‘ç ”åŠ©æ‰‹ã€‚
            ã€ä»»åŠ¡ã€‘å°†ä»¥ä¸‹"ç¢ç‰‡è‰ç¨¿"æ•´ç†å½’çº³è¿›"ç°æœ‰çŸ¥è¯†åº“"ã€‚
            
            ã€ç°æœ‰çŸ¥è¯†åº“ (JSON)ã€‘: 
            ${kbContext}
            
            ã€å¾…æ•´ç†è‰ç¨¿ã€‘:
            ${draftContent}
            
            ã€æ“ä½œè¦æ±‚ã€‘:
            1. åˆ†æè‰ç¨¿å†…å®¹ï¼Œå°†å…¶å½’ç±»åˆ°ç°æœ‰ Topicï¼Œæˆ–åˆ›å»ºåˆé€‚çš„æ–° Topic (å¦‚: å®éªŒè®°å½•ã€æ–‡çŒ®é˜…è¯»ã€çµæ„Ÿ)ã€‚
            2. æå–å…³é”®æ•°æ®ã€ç»“è®ºï¼Œæ›´æ–° summaryã€‚
            3. å¿…é¡»åªè¿”å›åˆå¹¶åçš„å®Œæ•´ JSON æ•°æ®ã€‚
            4. ä¸¥ç¦ä½¿ç”¨ Markdown ä»£ç å—æ ‡è®°ï¼Œç›´æ¥è¿”å›çº¯ JSON å­—ç¬¦ä¸²ã€‚
        `;

        try {
            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{"role": "user", "content": prompt}],
                    temperature: 0.1
                })
            });
            
            const data = await response.json();
            let jsonStr = data.choices[0].message.content;
            // æ¸…ç†å¯èƒ½çš„ markdown æ ‡è®°
            jsonStr = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
            
            // æ›´æ–°æ•°æ®
            appData.kb = JSON.parse(jsonStr);
            appData.drafts = []; // æ•´ç†æˆåŠŸæ‰æ¸…ç©º
            
            saveData();
            renderAll();
            btn.innerText = "âœ… æ•´ç†å®Œæˆï¼";
            
        } catch (e) {
            console.error(e);
            alert("æ•´ç†å¤±è´¥: " + e.message);
        } finally {
            btn.disabled = false;
            setTimeout(() => btn.innerText = oldText, 2000);
        }
    }

    // --- çŸ¥è¯†åº“æ¸²æŸ“ ---
    function renderKB(filterText = '') {
        const container = document.getElementById('kbContent');
        const kb = appData.kb;
        
        if (Object.keys(kb).length === 0) {
            container.innerHTML = `<div style="text-align:center;color:#cbd5e1;margin-top:50px;">
                ğŸ“š çŸ¥è¯†åº“ä¸ºç©º<br>è¯·åœ¨å·¦ä¾§æ·»åŠ ç¬”è®°å¹¶ç‚¹å‡»æ•´ç†
            </div>`;
            return;
        }

        let html = '';
        
        // éå†æ‰€æœ‰ Topic
        for (const [topic, data] of Object.entries(kb)) {
            // æœç´¢è¿‡æ»¤é€»è¾‘
            let hitSearch = false;
            if (filterText) {
                const str = JSON.stringify(data).toLowerCase() + topic.toLowerCase();
                if (str.includes(filterText.toLowerCase())) hitSearch = true;
                else continue; // ä¸åŒ¹é…åˆ™è·³è¿‡
            }

            // æ¸²æŸ“ Sections
            let sectionsHtml = '';
            if (data.sections) {
                data.sections.forEach(sec => {
                    // æ¸²æŸ“ Items
                    const itemsHtml = sec.items.map(item => {
                        // Markdown æ¸²æŸ“ + é«˜äº®
                        let rendered = marked.parseInline(item);
                        rendered = renderBioSubscripts(rendered); // æ¸²æŸ“åŒ–å­¦å¼
                        if (filterText) {
                            // ç®€å•é«˜äº®æ›¿æ¢
                            const reg = new RegExp(`(${filterText})`, 'gi');
                            rendered = rendered.replace(reg, '<span class="highlight">$1</span>');
                        }
                        return `<li>${rendered}</li>`;
                    }).join('');
                    
                    sectionsHtml += `
                        <div class="section-title">${sec.title}</div>
                        <ul class="kb-list">${itemsHtml}</ul>
                    `;
                });
            }

            // æ‹¼æ¥ Topic å¡ç‰‡
            html += `
                <div class="topic-card ${hitSearch ? '' : 'collapsed'}" id="topic-${topic}">
                    <div class="topic-header" onclick="toggleTopic(this)">
                        <div class="topic-title">${topic}</div>
                        <div class="topic-toggle">â–¼</div>
                    </div>
                    <div class="topic-body">
                        ${data.summary ? `<div class="summary-box">ğŸ’¡ ${data.summary}</div>` : ''}
                        ${sectionsHtml}
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html || `<div style="text-align:center;color:#cbd5e1;padding:20px">æœªæ‰¾åˆ°åŒ¹é…å†…å®¹</div>`;
        
        // æœ€åæ¸²æŸ“æ•°å­¦å…¬å¼
        renderMathInElement(container, {
            delimiters: [{left: '$', right: '$', display: false}],
            throwOnError: false
        });
    }

    // --- æœç´¢åŠŸèƒ½ (è¡¥å›æ¥äº†ï¼) ---
    function handleSearch(text) {
        renderKB(text.trim());
        // å¦‚æœæœ‰æœç´¢è¯ï¼Œè‡ªåŠ¨å±•å¼€æ‰€æœ‰ç»“æœ
        if (text.trim()) {
            document.querySelectorAll('.topic-card').forEach(el => el.classList.remove('collapsed'));
        }
    }

    function toggleTopic(header) {
        header.parentElement.classList.toggle('collapsed');
    }
    
    function expandAll() {
        document.querySelectorAll('.topic-card').forEach(el => el.classList.remove('collapsed'));
    }

    // ==========================================
    // 4ï¸âƒ£ ç”Ÿç‰©å·¥ç¨‹ä¸“å±ä¼˜åŒ– (Bio-Features)
    // ==========================================
    
    // ç”Ÿç‰©è¾“å…¥æ³•ç›‘å¬å™¨ (å®Œæ•´ç‰ˆï¼Œä¸ç¼©æ°´)
    function setupBioTyping() {
        const input = document.getElementById('mainInput');
        input.addEventListener('input', function(e) {
            const cursor = this.selectionStart;
            const val = this.value;
            
            // 1. ç®­å¤´ä¼˜åŒ–: -> å˜ â†’
            if (val.endsWith('->', cursor)) {
                replaceAt(this, cursor-2, cursor, 'â†’');
                return;
            }
            if (val.endsWith('=>', cursor)) {
                replaceAt(this, cursor-2, cursor, 'â‡’');
                return;
            }

            // 2. åŒ–å­¦å¼ä¸‹æ ‡ä¼˜åŒ– (CO2 + ç©ºæ ¼)
            // åªæœ‰æŒ‰ä¸‹ç©ºæ ¼æ—¶è§¦å‘
            if (e.data === ' ' || val.slice(cursor-1, cursor) === ' ') {
                // æˆªå–å…‰æ ‡å‰5ä¸ªå­—ç¬¦è¿›è¡Œåˆ†æ
                const chunk = val.slice(Math.max(0, cursor-6), cursor);
                // æ­£åˆ™ï¼š[å­—æ¯][æ•°å­—][ç©ºæ ¼]ç»“å°¾
                // æ¯”å¦‚ "O2 " æˆ– "He2 "
                const match = chunk.match(/([a-zA-Z]+)([0-9])\s$/);
                
                if (match) {
                    const fullMatch = match[0]; // e.g. "O2 "
                    const letters = match[1];   // "O"
                    const num = match[2];       // "2"
                    
                    const subMap = {'0':'â‚€','1':'â‚','2':'â‚‚','3':'â‚ƒ','4':'â‚„','5':'â‚…','6':'â‚†','7':'â‚‡','8':'â‚ˆ','9':'â‚‰'};
                    const newStr = letters + subMap[num] + ' ';
                    
                    // æ‰§è¡Œæ›¿æ¢
                    const start = cursor - fullMatch.length;
                    replaceAt(this, start, cursor, newStr);
                }
            }
        });
    }

    // è¾…åŠ©æ›¿æ¢å‡½æ•°ï¼Œä¿æŒå…‰æ ‡ä½ç½®
    function replaceAt(input, start, end, text) {
        const val = input.value;
        const before = val.slice(0, start);
        const after = val.slice(end);
        input.value = before + text + after;
        input.selectionStart = input.selectionEnd = start + text.length;
    }

    // æ¸²æŸ“æ—¶ä¹Ÿå†æ¬¡æ£€æŸ¥ (é˜²æ­¢æ¼ç½‘ä¹‹é±¼)
    function renderBioSubscripts(text) {
        // ç®€å•çš„æ›¿æ¢å¸¸è§åˆ†å­
        return text.replace(/CO2/g, 'COâ‚‚')
                   .replace(/H2O/g, 'Hâ‚‚O')
                   .replace(/O2/g, 'Oâ‚‚');
    }

    // å·¥å…·å‡½æ•°
    function escapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
    
    function copyText(text) {
        navigator.clipboard.writeText(text);
    }
    
    function openApiSettings() {
        document.getElementById('apiModal').style.display = 'flex';
        document.getElementById('apiKeyInput').value = localStorage.getItem('deepseek_key') || '';
    }
    
    function saveApiKey() {
        const k = document.getElementById('apiKeyInput').value;
        if(k) localStorage.setItem('deepseek_key', k);
        document.getElementById('apiModal').style.display = 'none';
    }

</script>
</body>
</html>

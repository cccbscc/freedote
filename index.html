<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freedote Pro (æ–°ç‰ˆUI + æ™ºèƒ½ç™»å½•)</title>
    
    <script src="https://cdn.staticfile.org/marked/9.1.2/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* === ğŸ¨ æ–°ç‰ˆ UI è®¾è®¡ç³»ç»Ÿ (5:5åˆ†å±) === */
        :root {
            --primary: #2563eb;       --primary-hover: #1d4ed8;
            --bg-body: #f8fafc;       --bg-panel: #f1f5f9;
            --border: #e2e8f0;        --text-main: #334155;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        body { margin: 0; padding: 0; font-family: system-ui, sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }
        * { box-sizing: border-box; }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* === ç™»å½•é¡µ (ä¿ç•™ä½ å–œæ¬¢çš„æ—§ç‰ˆé€»è¾‘) === */
        #loginOverlay {
            position: fixed; inset: 0; background: rgba(248, 250, 252, 0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-card {
            background: white; width: 360px; padding: 40px; border-radius: 16px; 
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); border: 1px solid var(--border); text-align: center;
        }
        .form-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .btn-primary:disabled { background: #94a3b8; cursor: wait; }

        /* === ä¸»ç•Œé¢ (æ–°ç‰ˆå·¦å³åˆ†å±) === */
        .split-view { display: flex; width: 100%; height: 100%; opacity: 0; transition: opacity 0.3s; }
        
        /* å·¦ä¾§ï¼šå·¥ä½œå° */
        .panel-left { flex: 1; display: flex; flex-direction: column; background: var(--bg-panel); border-right: 1px solid var(--border); padding: 20px; min-width: 350px; }
        
        /* å³ä¾§ï¼šæ¡£æ¡ˆæŸœ */
        .panel-right { flex: 1; display: flex; flex-direction: column; background: white; padding: 20px; min-width: 350px; overflow: hidden; }

        /* è¾“å…¥æ¡†ç»„ä»¶ */
        .input-box { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 15px; box-shadow: var(--shadow); margin-bottom: 15px; transition: border 0.2s; }
        .input-box:focus-within { border-color: var(--primary); }
        textarea { width: 100%; height: 100px; border: none; outline: none; resize: none; font-family: 'Consolas', monospace; font-size: 1rem; }
        
        /* æŒ‰é’®ç»„ */
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn-secondary { flex: 1; background: #f1f5f9; color: #475569; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-accent { flex: 1; background: #dbeafe; color: #2563eb; border: 1px solid #bfdbfe; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        
        /* è‰ç¨¿æ°”æ³¡ */
        .draft-bubble { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; position: relative; transition: transform 0.1s; }
        .draft-bubble:hover { border-color: #94a3b8; }
        .draft-meta { font-size: 0.75rem; color: #94a3b8; display: flex; justify-content: space-between; margin-bottom: 5px; }
        .draft-text { font-size: 0.95rem; white-space: pre-wrap; word-break: break-all; }
        
        /* çŸ¥è¯†åº“å¡ç‰‡ */
        .topic-card { border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; overflow: hidden; }
        .topic-header { padding: 15px; background: #fff; display: flex; justify-content: space-between; cursor: pointer; font-weight: bold; border-bottom: 1px solid transparent; }
        .topic-header:hover { background: #f8fafc; }
        .topic-body { padding: 15px; border-top: 1px solid #f1f5f9; display: block; }
        .topic-card.collapsed .topic-header { border-bottom: none; }
        .topic-card.collapsed .topic-body { display: none; }

        /* API è®¾ç½®å¼¹çª— */
        #apiModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h2 style="margin-top:0; color:#334155;">Freedote Pro</h2>
            <p style="color:#64748b; font-size:0.9rem; margin-bottom:20px;">ç”Ÿç‰©å·¥ç¨‹ç¬”è®°å° (æ–°ç‰ˆUI)</p>
            
            <input type="email" id="email" class="form-input" placeholder="é‚®ç®± (name@example.com)">
            <input type="password" id="password" class="form-input" placeholder="å¯†ç  (è‡³å°‘6ä½)">

            <button class="btn-primary" id="loginBtn" onclick="handleSmartAuth()">ğŸš€ ç™»å½• / è‡ªåŠ¨æ³¨å†Œ</button>
            
            <div id="loginMsg" style="color:#ef4444; margin-top:10px; font-size:0.9rem; min-height:20px;"></div>
            
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                <button onclick="startOfflineMode()" style="background:none; border:none; color:#94a3b8; text-decoration:underline; cursor:pointer;">
                    è·³è¿‡ç™»å½•ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼ â”
                </button>
            </div>
        </div>
    </div>

    <div id="apiModal">
        <div style="background:white; padding:25px; border-radius:12px; width:300px;">
            <h3>âš™ï¸ DeepSeek API</h3>
            <input type="password" id="apiKeyInput" class="form-input" placeholder="sk-..." style="margin-bottom:10px;">
            <button class="btn-primary" onclick="saveApiKey()">ä¿å­˜</button>
            <button onclick="document.getElementById('apiModal').style.display='none'" style="margin-top:10px; background:none; border:none; cursor:pointer; width:100%; color:#666;">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="split-view" id="mainApp">
        <div class="panel-left">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                <strong style="font-size:1.1rem;">ğŸ§ª å®éªŒå°</strong>
                <span onclick="openApiSettings()" style="cursor:pointer; color:#64748b; font-size:0.9rem;">âš™ï¸ è®¾ç½®</span>
            </div>

            <div class="input-box">
                <textarea id="mainInput" placeholder="åœ¨æ­¤é€Ÿè®°... (æ”¯æŒ CO2+ç©ºæ ¼ è‡ªåŠ¨ä¸‹æ ‡)"></textarea>
                <div class="btn-row">
                    <button class="btn-secondary" onclick="saveToDraft()">â¬‡ï¸ å­˜è‰ç¨¿</button>
                    <button class="btn-accent" onclick="directSave()">ğŸ“ é€Ÿè®°ä¸Šå±</button>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#94a3b8; margin-bottom:5px;">
                <span>ç¼“å†²æ±  (<span id="draftCount">0</span>)</span>
                <span onclick="clearAllDrafts()" style="cursor:pointer; color:#ef4444;">æ¸…ç©º</span>
            </div>

            <div id="draftStream" style="flex:1; overflow-y:auto; padding-right:5px;">
                </div>

            <button id="organizeBtn" class="btn-primary" style="margin-top:10px;" onclick="organizeAll()">ğŸ§  AI ä¸€é”®æ•´ç†</button>
            
            <div style="margin-top:10px; font-size:0.8rem; color:#94a3b8; display:flex; justify-content:space-between;">
                <span id="userStatus">æœªè¿æ¥</span>
                <span onclick="handleLogout()" style="cursor:pointer; text-decoration:underline;">é€€å‡º</span>
            </div>
        </div>

        <div class="panel-right">
            <div style="margin-bottom:15px;">
                <input type="text" class="form-input" style="margin-bottom:0; border-radius:8px;" placeholder="ğŸ” å…¨å±€æœç´¢ (æ”¯æŒé«˜äº®)..." oninput="renderKB(this.value)">
            </div>
            <div id="kbContent" style="flex:1; overflow-y:auto;">
                </div>
        </div>
    </div>

<script>
    // ================= é…ç½®åŒº =================
    // âš ï¸ ä½ çš„ Key å·²å¡«å¥½
    const SUPABASE_URL = 'https://bqziigrbjnabrtmpixnn.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxemlpZ3Jiam5hYnJ0bXBpeG5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0OTU2NzcsImV4cCI6MjA4MTA3MTY3N30.h45zVtr58IhT5-CYbTWBUZ2Cs9W9vzbK31qnTftlPmw'; 

    // å…¨å±€å˜é‡ (sbClient é˜²æ­¢å†²çª)
    let sbClient = null; 
    let appData = { drafts: [], kb: {} };
    let currentUser = null;
    let isOffline = false;

    // ================= åˆå§‹åŒ– =================
    window.onload = async function() {
        setupBioTyping();

        try {
            // åˆå§‹åŒ–å®¢æˆ·ç«¯
            if (typeof supabase !== 'undefined' && SUPABASE_URL.startsWith('http')) {
                sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // æ£€æŸ¥ Session (è‡ªåŠ¨ç™»å½•)
                const { data: { session } } = await sbClient.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    await enterCloudMode();
                    return;
                }
            }
        } catch (e) {
            console.error(e);
        }

        // æ˜¾ç¤ºç™»å½•é¡µ
        document.getElementById('loginOverlay').style.display = 'flex';
    };

    // ================= æ™ºèƒ½ç™»å½•é€»è¾‘ (ä¿®å¤ç‰ˆ) =================
    async function handleSmartAuth() {
        if (!sbClient) return alert("ç½‘ç»œæœªè¿æ¥ï¼Œè¯·æ£€æŸ¥ä»£ç é…ç½®");
        
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const btn = document.getElementById('loginBtn');
        const msg = document.getElementById('loginMsg');

        if (!email || !password) return msg.innerText = "è¯·è¾“å…¥è´¦å·å’Œå¯†ç ";

        try {
            btn.disabled = true;
            btn.innerText = "è¿æ¥ä¸­...";
            msg.innerText = "";

            // 1. å°è¯•ç›´æ¥ç™»å½•
            const { data, error } = await sbClient.auth.signInWithPassword({ email, password });

            if (error) {
                // 2. ç™»å½•å¤±è´¥ -> å°è¯•æ³¨å†Œ
                console.log("ç™»å½•å¤±è´¥ï¼Œå°è¯•è‡ªåŠ¨æ³¨å†Œ:", error.message);
                msg.innerText = "è´¦å·ä¸å­˜åœ¨ï¼Œæ­£åœ¨è‡ªåŠ¨æ³¨å†Œ...";
                
                const regRes = await sbClient.auth.signUp({ email, password });
                
                if (regRes.error) {
                    msg.innerText = "æ³¨å†Œå¤±è´¥: " + regRes.error.message;
                    btn.innerText = "ğŸš€ ç™»å½• / è‡ªåŠ¨æ³¨å†Œ";
                } else {
                    // 3. æ³¨å†ŒæˆåŠŸ -> è‡ªåŠ¨ç™»å½•
                    const loginRetry = await sbClient.auth.signInWithPassword({ email, password });
                    if (!loginRetry.error) {
                        currentUser = loginRetry.data.user;
                        await enterCloudMode();
                    } else {
                        msg.innerText = "æ³¨å†ŒæˆåŠŸï¼Œè¯·é‡æ–°ç‚¹å‡»ç™»å½•";
                        btn.innerText = "ğŸš€ ç™»å½• / è‡ªåŠ¨æ³¨å†Œ";
                    }
                }
            } else {
                // ç™»å½•æˆåŠŸ
                currentUser = data.user;
                await enterCloudMode();
            }
        } catch (e) {
            msg.innerText = "é”™è¯¯: " + e.message;
            btn.innerText = "ğŸš€ ç™»å½• / è‡ªåŠ¨æ³¨å†Œ";
        } finally {
            if(!currentUser) btn.disabled = false;
        }
    }

    function startOfflineMode() {
        isOffline = true;
        const local = localStorage.getItem('freedote_local');
        if (local) appData = JSON.parse(local);
        
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainApp').style.opacity = '1';
        document.getElementById('userStatus').innerText = "ç¦»çº¿æ¨¡å¼";
        renderAll();
    }

    async function enterCloudMode() {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainApp').style.opacity = '1';
        document.getElementById('userStatus').innerText = "â˜ï¸ " + currentUser.email;

        // æ‹‰å–æ•°æ®
        try {
            const { data, error } = await sbClient
                .from('notes')
                .select('content')
                .eq('user_id', currentUser.id)
                .single();

            if (data && data.content) {
                appData = data.content;
                // æ•°æ®è¡¥å…¨
                if (!appData.drafts) appData.drafts = [];
                if (!appData.kb) appData.kb = {};
            }
        } catch (e) { console.error(e); }
        renderAll();
    }

    async function handleLogout() {
        if (sbClient) await sbClient.auth.signOut();
        location.reload();
    }

    // ================= æ•°æ®ä¿å­˜ =================
    let saveTimer = null;
    function saveData() {
        // æœ¬åœ°å¤‡ä»½
        localStorage.setItem('freedote_local', JSON.stringify(appData));
        
        // äº‘ç«¯åŒæ­¥
        if (!isOffline && currentUser && sbClient) {
            document.getElementById('userStatus').innerText = "ğŸ”„ åŒæ­¥ä¸­...";
            clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                const { error } = await sbClient
                    .from('notes')
                    .upsert({ user_id: currentUser.id, content: appData }, { onConflict: 'user_id' });
                
                if (error) document.getElementById('userStatus').innerText = "âŒ åŒæ­¥å¤±è´¥";
                else document.getElementById('userStatus').innerText = "â˜ï¸ " + currentUser.email;
            }, 2000);
        }
    }

    // ================= æ ¸å¿ƒä¸šåŠ¡ (è‰ç¨¿ & KB) =================
    function renderAll() {
        renderDrafts();
        renderKB();
    }

    // è‰ç¨¿ç®±é€»è¾‘
    function saveToDraft() {
        const val = document.getElementById('mainInput').value.trim();
        if(!val) return;
        appData.drafts.unshift({ id: Date.now(), text: val, time: new Date().toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'}) });
        saveData();
        document.getElementById('mainInput').value = '';
        renderDrafts();
    }

    function renderDrafts() {
        const div = document.getElementById('draftStream');
        document.getElementById('draftCount').innerText = appData.drafts.length;
        if(appData.drafts.length === 0) {
            div.innerHTML = '<div style="text-align:center;color:#cbd5e1;padding:20px;">æš‚æ— è‰ç¨¿</div>';
            return;
        }
        div.innerHTML = appData.drafts.map((d, i) => `
            <div class="draft-bubble">
                <div class="draft-meta"><span>${d.time}</span> <span style="cursor:pointer;color:#ef4444" onclick="delDraft(${i})">Ã—</span></div>
                <div class="draft-text">${escapeHtml(d.text)}</div>
                <div style="margin-top:5px;text-align:right;">
                    <span style="font-size:0.8rem;color:#cbd5e1;cursor:pointer;" onclick="promote(${i})">ğŸ“ é€Ÿè®°ä¸Šå±</span>
                </div>
            </div>
        `).join('');
    }

    function delDraft(i) {
        appData.drafts.splice(i, 1);
        saveData();
        renderDrafts();
    }
    
    function promote(i) {
        document.getElementById('mainInput').value = appData.drafts[i].text;
        directSave();
        delDraft(i);
    }
    
    function clearAllDrafts() {
        if(confirm("ç¡®å®šæ¸…ç©ºè‰ç¨¿ï¼Ÿ")) { appData.drafts = []; saveData(); renderDrafts(); }
    }

    // é€Ÿè®°é€»è¾‘
    function directSave() {
        const val = document.getElementById('mainInput').value.trim();
        if(!val) return;
        const topic = "ğŸ“… é€Ÿè®°æ—¥å¿—";
        if (!appData.kb[topic]) appData.kb[topic] = { summary: "", sections: [{ title: "Log", items: [] }] };
        appData.kb[topic].sections[0].items.push(val);
        
        saveData();
        document.getElementById('mainInput').value = '';
        renderKB();
    }

    // çŸ¥è¯†åº“æ¸²æŸ“ (æ”¯æŒæœç´¢é«˜äº®)
    function renderKB(search = '') {
        const div = document.getElementById('kbContent');
        if(Object.keys(appData.kb).length === 0) {
            div.innerHTML = '<div style="text-align:center;color:#cbd5e1;margin-top:50px;">æš‚æ— å½’æ¡£å†…å®¹</div>';
            return;
        }
        let html = '';
        for (const [topic, data] of Object.entries(appData.kb)) {
            // ç®€å•æœç´¢è¿‡æ»¤
            if (search && !JSON.stringify(data).toLowerCase().includes(search.toLowerCase()) && !topic.toLowerCase().includes(search.toLowerCase())) continue;
            
            let secs = '';
            if (data.sections) {
                data.sections.forEach(s => {
                    const itemsHtml = s.items.map(i => {
                        let text = marked.parseInline(i.replace(/CO2/g,'COâ‚‚')); // ç”Ÿç‰©ç¬¦å·æ¸²æŸ“
                        if(search) text = text.replace(new RegExp(`(${search})`, 'gi'), '<span style="background:#fef08a">$1</span>');
                        return `<li>${text}</li>`;
                    }).join('');
                    secs += `<div style="font-weight:bold;margin-top:10px;color:#475569">${s.title}</div><ul>${itemsHtml}</ul>`;
                });
            }
            html += `
                <div class="topic-card ${search ? '' : 'collapsed'}">
                    <div class="topic-header" onclick="this.parentElement.classList.toggle('collapsed')">
                        ${topic} <span style="font-size:0.8rem;color:#ccc">â–¼</span>
                    </div>
                    <div class="topic-body">${secs}</div>
                </div>`;
        }
        div.innerHTML = html || '<div style="text-align:center;color:#cbd5e1;">æ— åŒ¹é…ç»“æœ</div>';
    }

    // AI æ•´ç†
    async function organizeAll() {
        const key = localStorage.getItem('deepseek_key');
        if (!key) { openApiSettings(); return; }
        if (appData.drafts.length === 0) return alert("æ— è‰ç¨¿");

        const btn = document.getElementById('organizeBtn');
        btn.innerText = "â³ æ•´ç†ä¸­..."; btn.disabled = true;

        try {
            const res = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{ role: "user", content: `åˆå¹¶æ–°è‰ç¨¿è¿›çŸ¥è¯†åº“KBã€‚KB:${JSON.stringify(appData.kb)} è‰ç¨¿:${JSON.stringify(appData.drafts)}ã€‚åªè¿”å›JSONã€‚` }]
                })
            });
            const data = await res.json();
            const json = data.choices[0].message.content.replace(/```json|```/g, '').trim();
            appData.kb = JSON.parse(json);
            appData.drafts = [];
            saveData();
            renderAll();
        } catch(e) { alert("æ•´ç†å¤±è´¥: " + e.message); }
        finally { btn.disabled = false; btn.innerText = "ğŸ§  AI ä¸€é”®æ•´ç†"; }
    }

    // å·¥å…·å‡½æ•°
    function setupBioTyping() {
        document.getElementById('mainInput').addEventListener('input', function(e) {
            const cursor = this.selectionStart;
            const val = this.value;
            // CO2 -> COâ‚‚
            if (e.data === ' ' || val.slice(cursor-1, cursor) === ' ') {
                const chunk = val.slice(Math.max(0, cursor-6), cursor);
                const match = chunk.match(/([a-zA-Z]+)([0-9])\s$/);
                if (match) {
                    const subMap = {'0':'â‚€','1':'â‚','2':'â‚‚','3':'â‚ƒ','4':'â‚„','5':'â‚…','6':'â‚†','7':'â‚‡','8':'â‚ˆ','9':'â‚‰'};
                    const newStr = match[1] + subMap[match[2]] + ' ';
                    this.value = val.slice(0, cursor - match[0].length) + newStr + val.slice(cursor);
                    this.selectionStart = this.selectionEnd = cursor - 1;
                }
            }
        });
    }
    function openApiSettings() {
        document.getElementById('apiModal').style.display = 'flex';
        document.getElementById('apiKeyInput').value = localStorage.getItem('deepseek_key') || '';
    }
    function saveApiKey() {
        const k = document.getElementById('apiKeyInput').value;
        if(k) localStorage.setItem('deepseek_key', k);
        document.getElementById('apiModal').style.display = 'none';
    }
    function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

</script>
</body>
</html>

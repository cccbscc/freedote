<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Freedote Pro (ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.staticfile.org/marked/9.1.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* === æ ·å¼è¡¨ (ä¿æŒåŸç‰ˆé£æ ¼) === */
        :root { --primary-color: #2563eb; --bg-color: #f8fafc; --header-height: 50px;}
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; color: #333;}

        /* ç™»å½•é®ç½© */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f1f5f9; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 35px 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 90%; max-width: 360px; text-align: center; }
        .login-box h2 { margin-top: 0; color: #1e293b; font-size: 1.5rem; margin-bottom: 5px;}
        .login-sub { color: #64748b; font-size: 0.9rem; margin-bottom: 25px; }
        .input-group { text-align: left; margin-bottom: 15px; }
        .login-box input { width: 100%; padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; transition: border 0.2s; outline: none; background: #f8fafc;}
        .login-box input:focus { border-color: var(--primary-color); background: white; }
        .main-btn { width: 100%; padding: 14px; background: var(--primary-color); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
        .main-btn:disabled { background: #94a3b8; cursor: wait; }
        .msg { color: #ef4444; font-size: 0.85rem; margin-top: 15px; min-height: 20px;}

        /* ä¸»ç•Œé¢ */
        .app-container { display: flex; flex-direction: column; height: 100%; filter: blur(0); transition: filter 0.3s;}
        .app-container.blur { filter: blur(5px); }
        .header { background: #fff; padding: 0 15px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; height: var(--header-height); flex-shrink: 0; z-index: 20;}
        .header h1 { margin: 0; font-size: 1rem; color: #1e293b; font-weight: 700; display:flex; align-items:center; gap:5px;}
        .user-info { font-size: 0.8rem; color: #64748b; display: flex; align-items: center; gap: 8px; }
        .logout-link { color: #ef4444; cursor: pointer; text-decoration: underline;}

        /* è®¾ç½®é¢æ¿ */
        .config-panel { position: absolute; top: 50px; right: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid #e2e8f0; z-index: 100; display: none; width: 260px;}
        .config-panel.show { display: block; }
        .config-panel input { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 14px;}

        /* æ ‡ç­¾æ  */
        .tab-bar { background: #e2e8f0; display: flex; align-items: flex-end; padding-left: 10px; gap: 4px; height: 40px; overflow-x: auto; flex-shrink: 0; border-bottom: 1px solid #cbd5e1; scrollbar-width: none;}
        .tab { padding: 10px 15px; background: #cbd5e1; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 0.85rem; color: #475569; white-space: nowrap; }
        .tab.active { background: white; color: var(--primary-color); font-weight: bold; padding-top: 12px; margin-top: -2px; box-shadow: 0 -2px 4px rgba(0,0,0,0.05); }
        .tab-close { margin-left: 5px; opacity: 0.6; font-size: 0.7rem; }
        .add-tab-btn { padding: 10px 15px; font-weight: bold; color: #64748b; cursor: pointer; }

        /* å†…å®¹åŒº */
        .main-body { display: flex; flex: 1; overflow: hidden; position: relative; transition: all 0.3s; background: white;}
        
        /* å·¦ä¾§é¢æ¿ */
        .left-panel { width: 350px; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; padding: 15px; z-index: 10; background: #fff; transition: width 0.3s;}
        .left-panel.collapsed { width: 40px; padding: 5px; }
        
        /* å¯¼èˆªæ  */
        .nav-panel { width: 220px; background: #f8fafc; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto;}
        .nav-item { padding: 10px 15px; cursor: pointer; color: #334155; font-size: 0.9rem; border-bottom: 1px solid #f1f5f9;}
        .nav-item:hover { background: #e2e8f0; }

        /* å³ä¾§æ­£æ–‡ */
        .content-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; position: relative;}
        .markdown-scroll { flex: 1; overflow-y: auto; padding: 40px; }
        .markdown-body { max-width: 800px; margin: 0 auto; line-height: 1.7; color: #333; }
        .markdown-body h1 { border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .markdown-body blockquote { border-left: 4px solid var(--primary-color); margin: 10px 0; padding: 5px 15px; background: #f8fafc; color: #555; }

        /* è¾“å…¥æ§ä»¶ */
        textarea#userInput { width: 100%; height: 120px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; resize: none; margin-bottom: 10px; font-family: inherit; font-size: 14px;}
        textarea#userInput:focus { outline: 2px solid var(--primary-color); border-color: transparent; }
        button.action-btn { border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; color: white; width: 100%; margin-bottom: 8px; font-size: 14px; background: var(--primary-color);}
        button.action-btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: #475569; width: 100%; padding: 8px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-bottom: 5px; font-size: 0.85rem;}
        .status-box { margin-bottom: 5px; min-height: 20px; font-size: 0.8rem; color: var(--primary-color); font-weight: bold; }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .main-body { flex-direction: column; }
            .left-panel { width: 100%; height: auto; border-right: none; border-bottom: 1px solid #e2e8f0; order: 1; padding: 10px;}
            .nav-panel { width: 100%; height: 50px; flex-direction: row; order: 2; overflow-x: auto; white-space: nowrap; align-items: center;}
            .content-panel { order: 3; }
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2>Freedote Pro</h2>
        <div class="login-sub">ç”Ÿç‰©å·¥ç¨‹ç ”ç©¶ç”Ÿä¸“ç”¨ Â· æ™ºèƒ½äº‘ç¬”è®°</div>

        <div class="input-group">
            <input type="email" id="email" placeholder="é‚®ç®± (name@example.com)">
        </div>
        <div class="input-group">
            <input type="password" id="password" placeholder="å¯†ç  (è‡³å°‘6ä½)">
        </div>
        
        <button class="main-btn" id="smartLoginBtn" onclick="handleSmartAuth()">ğŸš€ ç™»å½• / è‡ªåŠ¨æ³¨å†Œ</button>
        
        <div class="msg" id="loginMsg"></div>
        
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <span style="color:#64748b; cursor:pointer; font-size:0.9rem; text-decoration:underline;" onclick="startOfflineMode()">
                æš‚ä¸ç™»å½•ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼ â”
            </span>
        </div>
    </div>
</div>

<div class="app-container blur" id="appContainer">
    <div class="header">
        <h1>ğŸ“‘ çŸ¥è¯†åº“ <span id="modeTag" style="font-size:0.7em; background:#eee; padding:2px 6px; border-radius:4px; margin-left:5px;">ç¦»çº¿ç‰ˆ</span></h1>
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="user-info"><span id="userEmail"></span><span class="logout-link" onclick="handleLogout()">[é€€å‡º]</span></div>
            <button class="btn-outline" style="width:auto; margin:0;" onclick="toggleConfig()">âš™ï¸ è®¾ç½®</button>
        </div>
        <div class="config-panel" id="configPanel">
            <h4>API è®¾ç½®</h4>
            <input type="password" id="apiKey" placeholder="DeepSeek API Key (sk-...)" onchange="saveSettings()">
            <input type="text" id="modelName" placeholder="deepseek-chat" value="deepseek-chat" onchange="saveSettings()">
            <label style="font-size:0.85rem; display:block; margin-top:5px; color:#666;">
                <input type="checkbox" id="syncKey" onchange="saveSettings()"> â˜ï¸ åŒæ­¥ Key åˆ°äº‘ç«¯
            </label>
        </div>
    </div>

    <div class="tab-bar" id="tabBar"></div>

    <div class="main-body">
        <div class="left-panel" id="inputPanel">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-weight:bold; color:#475569;">
                <span>âš¡ å®éªŒå°</span>
                <label style="font-size:0.8rem; font-weight:normal; display:flex; align-items:center;">
                    <input type="checkbox" id="autoOrganize" checked style="margin-right:5px;"> AI æ•´ç†
                </label>
            </div>
            
            <textarea id="userInput" placeholder="è¾“å…¥å†…å®¹... (æ”¯æŒ CO2+ç©ºæ ¼ è‡ªåŠ¨ä¸‹æ ‡ï¼Œè¾“å…¥ @åˆ†ç±» å¯è‡ªåŠ¨å½’æ¡£)"></textarea>
            <div id="status" class="status-box"></div>
            
            <button class="action-btn" onclick="processInput()">ğŸš€ æ‰§è¡Œå¤„ç†</button>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <button class="btn-outline" onclick="exportMarkdown()">ğŸ“„ å¯¼å‡º MD</button>
                <button class="btn-outline" onclick="exportJSON()">âš™ï¸ å¯¼å‡º JSON</button>
            </div>
            <button class="btn-outline" style="color:#ef4444; margin-top:5px;" onclick="clearCurrentTab()">ğŸ—‘ï¸ æ¸…ç©ºå½“å‰åˆ†ç±»</button>
        </div>

        <div class="nav-panel" id="navList"></div>

        <div class="content-panel">
            <div class="markdown-scroll">
                <div id="markdownOutput" class="markdown-body"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================
    // âš ï¸ Supabase é…ç½® (ç›´æ¥ä½¿ç”¨ä½ æä¾›çš„ Key)
    // ============================================
    const SUPABASE_URL = 'https://bqziigrbjnabrtmpixnn.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxemlpZ3Jiam5hYnJ0bXBpeG5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0OTU2NzcsImV4cCI6MjA4MTA3MTY3N30.h45zVtr58IhT5-CYbTWBUZ2Cs9W9vzbK31qnTftlPmw'; 
    // ============================================

    // === æ ¸å¿ƒå˜é‡ (sbClient é˜²æ­¢å†²çª) ===
    let sbClient = null;
    let isLocalMode = false;
    let currentUser = null;
    let noteData = { tabs: [], content_map: {}, settings: {} }; 
    let currentTabId = 'tab_guide';

    // é»˜è®¤æ•°æ®
    const DEFAULT_NOTE_DATA = {
      "tabs": [
        { "id": "tab_guide", "name": "ğŸ“˜ ä½¿ç”¨æ‰‹å†Œ" }
      ],
      "content_map": {
        "tab_guide": {
          "å¿«é€Ÿå…¥é—¨": {
            "summary": "æ¬¢è¿å›æ¥ï¼",
            "sections": [
              { "title": "å¦‚ä½•ä½¿ç”¨ï¼Ÿ", "items": ["å·¦ä¾§è¾“å…¥å†…å®¹ï¼Œç‚¹å‡»æ‰§è¡Œã€‚", "æ”¯æŒ CO2 è‡ªåŠ¨ä¸‹æ ‡ã€‚"] }
            ]
          }
        }
      },
      "settings": {}
    };

    // === 1. åˆå§‹åŒ–é€»è¾‘ ===
    window.onload = async function() {
        // æ¢å¤ Key
        if(localStorage.getItem('apiKey')) document.getElementById('apiKey').value = localStorage.getItem('apiKey');

        // åˆå§‹åŒ– Supabase
        try {
            // åªè¦ window.supabase å­˜åœ¨ï¼Œå°±åˆ›å»ºå®¢æˆ·ç«¯
            if (typeof supabase !== 'undefined') {
                sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch(e) { console.error("Supabase Init Error:", e); }

        // æ£€æŸ¥è‡ªåŠ¨ç™»å½•
        if (sbClient) {
            const { data: { session } } = await sbClient.auth.getSession();
            if (session) {
                loginSuccess(session.user);
                return;
            }
        }

        // æ£€æŸ¥ç¦»çº¿æ¨¡å¼
        if (localStorage.getItem('is_local_mode') === 'true') {
            startOfflineMode();
        }
    }

    // === 2. æ™ºèƒ½ç™»å½•/æ³¨å†Œé€»è¾‘ (ä¿®å¤ç‰ˆ) ===
    async function handleSmartAuth() {
        if (!sbClient) return alert("Supabase æœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
        
        const btn = document.getElementById('smartLoginBtn');
        const msg = document.getElementById('loginMsg');
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();

        if (!email || !password) {
            msg.innerText = "è¯·è¾“å…¥è´¦å·å’Œå¯†ç ";
            return;
        }

        try {
            btn.disabled = true; 
            btn.innerText = "è¿æ¥ä¸­...";
            msg.innerText = "";

            // 1. å°è¯•ç™»å½•
            const { data, error } = await sbClient.auth.signInWithPassword({ email, password });

            if (error) {
                // 2. ç™»å½•å¤±è´¥ -> å°è¯•æ³¨å†Œ
                console.log("ç™»å½•å¤±è´¥ï¼Œå°è¯•æ³¨å†Œ:", error.message);
                msg.innerText = "è´¦å·ä¸å­˜åœ¨ï¼Œæ­£åœ¨è‡ªåŠ¨æ³¨å†Œ...";
                
                const regRes = await sbClient.auth.signUp({ email, password });
                
                if (regRes.error) {
                    msg.innerText = "æ³¨å†Œå¤±è´¥: " + regRes.error.message;
                    btn.innerText = "ğŸš€ ç™»å½• / è‡ªåŠ¨æ³¨å†Œ";
                } else {
                    // 3. æ³¨å†ŒæˆåŠŸ -> è‡ªåŠ¨ç™»å½•
                    const loginRetry = await sbClient.auth.signInWithPassword({ email, password });
                    if (!loginRetry.error) {
                        loginSuccess(loginRetry.data.user);
                    } else {
                        msg.innerText = "æ³¨å†ŒæˆåŠŸï¼Œè¯·é‡æ–°ç‚¹å‡»ç™»å½•";
                        btn.innerText = "ğŸš€ ç™»å½• / è‡ªåŠ¨æ³¨å†Œ";
                    }
                }
            } else {
                loginSuccess(data.user);
            }
        } catch(e) { 
            msg.innerText = "é”™è¯¯: " + e.message; 
            btn.innerText = "ğŸš€ ç™»å½• / è‡ªåŠ¨æ³¨å†Œ";
        } finally { 
            btn.disabled = false; 
        }
    }

    async function loginSuccess(user) {
        isLocalMode = false;
        currentUser = user;
        localStorage.removeItem('is_local_mode');
        
        document.getElementById('userEmail').innerText = `â˜ï¸ ${user.email}`;
        document.getElementById('modeTag').innerText = "äº‘ç«¯ç‰ˆ";
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('appContainer').classList.remove('blur');
        
        await loadData();
    }

    function startOfflineMode() {
        isLocalMode = true;
        currentUser = { id: 'local_user', email: 'Local' };
        localStorage.setItem('is_local_mode', 'true');
        
        document.getElementById('userEmail').innerText = "ğŸ  æœ¬åœ°æ¨¡å¼";
        document.getElementById('modeTag').innerText = "ç¦»çº¿ç‰ˆ";
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('appContainer').classList.remove('blur');
        
        loadData();
    }

    async function handleLogout() {
        if(!confirm("ç¡®å®šé€€å‡ºï¼Ÿ")) return;
        localStorage.removeItem('is_local_mode');
        if(!isLocalMode && sbClient) await sbClient.auth.signOut();
        location.reload();
    }

    // === 3. æ•°æ®å­˜å– ===
    async function loadData() {
        document.getElementById('status').innerText = "ğŸ”„";
        try {
            if (isLocalMode) {
                const localRaw = localStorage.getItem('freedote_data');
                noteData = localRaw ? JSON.parse(localRaw) : JSON.parse(JSON.stringify(DEFAULT_NOTE_DATA));
            } else {
                const { data } = await sbClient.from('notes').select('content').eq('user_id', currentUser.id).single();
                noteData = (data && data.content) ? data.content : JSON.parse(JSON.stringify(DEFAULT_NOTE_DATA));
            }
        } catch(e) { console.error(e); }

        // æ•°æ®ç»“æ„ä¿®å¤
        if(!noteData.tabs || noteData.tabs.length===0) noteData.tabs = [...DEFAULT_NOTE_DATA.tabs];
        if(!noteData.content_map) noteData.content_map = {};
        if(!noteData.tabs.find(t=>t.id===currentTabId)) currentTabId = noteData.tabs[0].id;

        // æ¢å¤äº‘ç«¯ Key
        if(noteData.settings?.apiKey) {
            document.getElementById('apiKey').value = noteData.settings.apiKey;
            localStorage.setItem('apiKey', noteData.settings.apiKey);
        }

        renderUI();
        document.getElementById('status').innerText = "";
    }

    async function saveData() {
        if (!currentUser) return;
        
        // ä¿å­˜ Key é…ç½®
        if(!noteData.settings) noteData.settings = {};
        if(!isLocalMode && document.getElementById('syncKey').checked) {
             noteData.settings.apiKey = document.getElementById('apiKey').value;
        }

        if (isLocalMode) {
            localStorage.setItem('freedote_data', JSON.stringify(noteData));
        } else {
            const { data } = await sbClient.from('notes').select('id').eq('user_id', currentUser.id).single();
            if (data) {
                await sbClient.from('notes').update({ content: noteData, updated_at: new Date() }).eq('user_id', currentUser.id);
            } else {
                await sbClient.from('notes').insert({ user_id: currentUser.id, content: noteData });
            }
        }
    }

    function saveSettings() {
        localStorage.setItem('apiKey', document.getElementById('apiKey').value);
        localStorage.setItem('modelName', document.getElementById('modelName').value);
        saveData();
    }

    // === 4. AI å¤„ç†é€»è¾‘ (å…¨åŠŸèƒ½ä¿ç•™) ===
    async function processInput() {
        let input = document.getElementById('userInput').value.trim();
        if(!input) return;
        
        const autoOrganize = document.getElementById('autoOrganize').checked;
        const btn = document.querySelector('.action-btn');
        const status = document.getElementById('status');
        
        try {
            btn.disabled = true; status.innerText = "ğŸ§  AI å¤„ç†ä¸­...";
            
            // ç®€å•æŒ‡ä»¤
            if(input.startsWith("@")) {
                const match = input.match(/^@(\S+)\s+(.*)/);
                if(match) {
                    const topic = match[1];
                    const content = match[2];
                    addToTopic(topic, content);
                    finishProcess();
                    return;
                }
            }

            if (!autoOrganize) {
                // ä¸å¼€å¯ AIï¼Œç›´æ¥å­˜å…¥â€œé€Ÿè®°â€
                addToTopic("é€Ÿè®°", input);
                finishProcess();
                return;
            }

            // å¼€å¯ AIï¼šè°ƒç”¨ LLM
            const apiKey = document.getElementById('apiKey').value;
            if(!apiKey) throw new Error("è¯·å…ˆè®¾ç½® API Key");

            const currentTabName = noteData.tabs.find(t=>t.id===currentTabId).name;
            const currentTopics = noteData.content_map[currentTabId] || {};
            
            const prompt = `
            ä½ æ˜¯ä¸€ä¸ªç¬”è®°æ•´ç†åŠ©æ‰‹ã€‚å½“å‰åˆ†ç±»: "${currentTabName}"
            å·²æœ‰ä¸»é¢˜: ${JSON.stringify(Object.keys(currentTopics))}
            è¾“å…¥å†…å®¹: "${input}"
            
            è¯·è¿”å› JSON: {"topic": "ä¸»é¢˜å", "summary": "æ‘˜è¦", "sections": [{"title": "å°èŠ‚", "items": ["å†…å®¹"]}]}
            å¦‚æœæ˜¯æ–°ä¸»é¢˜ï¼Œè¯·èµ·ä¸€ä¸ªç®€çŸ­çš„åå­—ã€‚å¦‚æœæ˜¯å·²æœ‰ä¸»é¢˜ï¼Œè¯·åˆå¹¶ã€‚
            `;

            const res = await fetch(`https://api.deepseek.com/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: document.getElementById('modelName').value || "deepseek-chat",
                    messages: [{role: "user", content: prompt}],
                    response_format: { type: "json_object" }
                })
            });
            
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            
            const result = JSON.parse(data.choices[0].message.content);
            const topic = result.topic || "æœªåˆ†ç±»";
            
            if(!noteData.content_map[currentTabId]) noteData.content_map[currentTabId] = {};
            noteData.content_map[currentTabId][topic] = result;
            
            finishProcess();

        } catch(e) {
            console.error(e);
            status.innerText = "âŒ " + e.message;
            alert("æ‰§è¡Œå¤±è´¥: " + e.message);
        } finally {
            btn.disabled = false;
        }

        function finishProcess() {
            saveData();
            renderUI();
            document.getElementById('userInput').value = '';
            status.innerText = "âœ… å®Œæˆ";
            setTimeout(()=>status.innerText="", 2000);
        }
    }

    function addToTopic(topic, content) {
        if(!noteData.content_map[currentTabId]) noteData.content_map[currentTabId] = {};
        if(!noteData.content_map[currentTabId][topic]) {
            noteData.content_map[currentTabId][topic] = { summary: "é€Ÿè®°", sections: [] };
        }
        const tData = noteData.content_map[currentTabId][topic];
        if(!tData.sections) tData.sections = [];
        let lastSec = tData.sections[tData.sections.length-1];
        if(!lastSec) tData.sections.push({title: "è®°å½•", items: [content]});
        else lastSec.items.push(content);
    }

    // === 5. UI æ¸²æŸ“ ===
    function renderUI() {
        const tabContainer = document.getElementById('tabBar');
        tabContainer.innerHTML = '';
        (noteData.tabs || []).forEach(tab => {
            const div = document.createElement('div');
            div.className = `tab ${tab.id === currentTabId ? 'active' : ''}`;
            div.innerHTML = `<span onclick="switchTab('${tab.id}')">${tab.name}</span><span class="tab-close" onclick="deleteTab('${tab.id}', event)">âœ•</span>`;
            tabContainer.appendChild(div);
        });
        const add = document.createElement('div');
        add.className = 'add-tab-btn'; add.innerText = '+'; add.onclick = addNewTab;
        tabContainer.appendChild(add);
        
        renderContent();
    }

    function renderContent() {
        const topics = noteData.content_map[currentTabId] || {};
        const navDiv = document.getElementById('navList');
        const contentDiv = document.getElementById('markdownOutput');
        
        let md = "", navHtml = "";
        
        if(Object.keys(topics).length === 0) {
            contentDiv.innerHTML = '<div style="text-align:center;padding-top:50px;color:#ccc;">æš‚æ— å†…å®¹</div>';
            navDiv.innerHTML = '';
            return;
        }

        for(const [name, data] of Object.entries(topics)) {
            navHtml += `<div class="nav-item" onclick="document.getElementById('t-${name}').scrollIntoView({behavior:'smooth'})">${name}</div>`;
            md += `<h1 id="t-${name}">${name}</h1>\n\n`;
            if(data.summary) md += `> ${data.summary}\n\n`;
            if(data.sections) {
                data.sections.forEach(s => {
                    md += `### ${s.title}\n`;
                    if(s.items) s.items.forEach(i => md += `- ${i}\n`);
                    md += `\n`;
                });
            }
            md += `---\n\n`;
        }
        navDiv.innerHTML = navHtml;
        contentDiv.innerHTML = marked.parse(md);
    }

    // === 6. å·¥å…·å‡½æ•° ===
    function switchTab(id) { currentTabId = id; renderUI(); }
    function addNewTab() { const n = prompt("æ–°åˆ†ç±»åç§°:"); if(n) { noteData.tabs.push({id:'tab_'+Date.now(), name:n}); switchTab(noteData.tabs[noteData.tabs.length-1].id); saveData(); } }
    function deleteTab(id, e) { e.stopPropagation(); if(noteData.tabs.length<=1)return alert("ä¿ç•™ä¸€ä¸ª"); if(confirm("åˆ é™¤?")) { noteData.tabs=noteData.tabs.filter(t=>t.id!==id); delete noteData.content_map[id]; switchTab(noteData.tabs[0].id); saveData(); } }
    function clearCurrentTab() { if(confirm("æ¸…ç©ºå½“å‰åˆ†ç±»ï¼Ÿ")) { noteData.content_map[currentTabId]={}; renderUI(); saveData(); } }
    function toggleConfig() { document.getElementById('configPanel').classList.toggle('show'); }
    
    function exportMarkdown() {
        const topics = noteData.content_map[currentTabId] || {}; 
        const name = noteData.tabs.find(t=>t.id===currentTabId).name;
        let md = `# ${name}\n\n`; 
        for(const [k,v] of Object.entries(topics)) { 
            md+=`# ${k}\n\n> ${v.summary||''}\n\n`; 
            if(v.sections) v.sections.forEach(s=>{ md+=`### ${s.title}\n`; if(s.items) s.items.forEach(i=>md+=`- ${i}\n`); }); 
            md+=`---\n`; 
        }
        downloadFile(`${name}.md`, md, 'text/markdown');
    }
    
    function exportJSON() {
        downloadFile(`backup_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(noteData, null, 2), 'application/json');
    }

    function downloadFile(filename, content, type) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([content], {type: type}));
        a.download = filename;
        a.click();
    }

    // ç”Ÿç‰©è¾“å…¥æ³• (CO2 -> COâ‚‚)
    document.getElementById('userInput').addEventListener('input', function(e) {
        let val = this.value;
        const cursor = this.selectionStart;
        
        // ç¬¦å·æ›¿æ¢
        if(val.endsWith('->')) {
            this.value = val.slice(0, -2) + 'â†’';
            this.selectionStart = this.selectionEnd = cursor - 1;
        }

        // CO2 æ›¿æ¢
        if(e.data === ' ' || val.slice(cursor-1, cursor) === ' ') {
            const chunk = val.slice(Math.max(0, cursor-6), cursor);
            const match = chunk.match(/([a-zA-Z]+)([0-9])\s$/);
            if (match) {
                const subMap = {'0':'â‚€','1':'â‚','2':'â‚‚','3':'â‚ƒ','4':'â‚„','5':'â‚…','6':'â‚†','7':'â‚‡','8':'â‚ˆ','9':'â‚‰'};
                const newStr = match[1] + subMap[match[2]] + ' ';
                this.value = val.slice(0, cursor - match[0].length) + newStr + val.slice(cursor);
                this.selectionStart = this.selectionEnd = cursor - 1;
            }
        }
    });

</script>
</body>
</html>
